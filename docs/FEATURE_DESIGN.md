# 功能设计文档 (Feature Design Document)

## 1. 世界管理系统 (World Management)

### 1.1 新建世界
*   **功能描述**: 允许用户从预设的理论框架中选择一个作为世界的基础结构。
*   **支持框架**:
    *   **布伦纳生态系统理论**: 包含微观、中介、外层、宏观、历时五个系统。
    *   **马克思历史唯物主义**: 包含生产力、生产关系、政治上层建筑、观念上层建筑、历史运动五个层级。
*   **交互**: 模态框展示框架卡片，包含名称和详细描述。
*   **初始化**: 设置默认的世界观背景（Context）和时间设定。

### 1.2 数据持久化
*   **技术方案**: Firebase Firestore。
*   **功能点**:
    *   **保存**: 将当前的世界模型、故事片段、史书文本打包上传。支持重命名世界。
    *   **加载**: 列出云端存档列表（按时间排序），显示元数据（框架类型、最后修改时间）。
    *   **自动清洗**: 保存前自动移除数据中的 `undefined` 字段以符合 Firestore 规范。

## 2. 系统参与者视图 (System Participants View)

### 2.1 层级卡片 (Layer Cards)
*   **展示**: 根据选定的框架，动态渲染 5 个不同颜色的层级卡片。
*   **实体管理**:
    *   **查看**: 卡片内网格化展示实体（Entity）名称和描述。
    *   **新增**: 手动添加实体名称和详细描述。
    *   **编辑/删除**: 支持对每一个实体的名称和描述进行修改或移除。
*   **AI 辅助生成 (单层级)**:
    *   提供“魔法棒”按钮，调用 Gemini API 为特定层级生成 3 个符合定义的实体。
    *   **差异化 Prompt**: 强制要求生成的实体具有对立性、多样性，而非同质化。

## 3. 全局同步与构建 (Global Synchronization)

### 3.1 智能状态判断
*   **逻辑**: 系统实时监测当前世界是否为“空”（无实体且无史书）。
*   **UI 表现**:
    *   **空状态**: 按钮显示为“🪄 构建新世界”（翠绿色），强调创造。
    *   **有内容**: 按钮显示为“🔄 更新世界设定”（紫罗兰色），强调同步。

### 3.2 同步逻辑 (`handleGlobalSync`)
*   **流程**:
    1.  **实体补全**: 遍历所有层级，如果某层级为空，自动调用 AI 补全该层级的实体。
    2.  **史书重写**: 将（更新后的）所有实体数据和当前的故事线打包，发送给 AI。
    3.  **生成史书**: AI 以“历史记录者”身份，采用白描手法生成 Markdown 格式的世界编年史。
    4.  **状态更新**: 将生成的内容回填至前端状态，并自动刷新相关视图。

## 4. 时间轴视图 (Timeline View)

### 4.1 核心可视化
*   **X 轴 (时间)**: 映射 `StorySegments` 的时间戳。如果无故事，则显示预设的“当前-近期-中期”占位符。
*   **Y 轴 (影响力流)**:
    *   使用 SVG 绘制类似 ThemeRiver (河流图) 的流体形状。
    *   每一个实体对应一条河流，颜色与其所属层级对应。
    *   **宽度算法**: 基于伪随机数生成基础波浪，若实体名字在当前时间点的故事文本中被提及，则河流显著变宽（模拟影响力爆发）。

### 4.2 事件标记 (Event Markers)
*   **数据源**: 来自框架中的“时间维度”层级（如历时系统或历史运动）。
*   **渲染**: 在时间轴上方绘制悬挂点。
*   **交互**: 鼠标悬停显示事件详情；若事件描述中包含某实体名称，该实体的河流高亮显示（红色描边），体现事件与参与者的关联。

## 5. 史书视图 (Chronicle View)

### 5.1 所见即所得编辑
*   **编辑器核心**: 集成 **Milkdown** (基于 ProseMirror)。
*   **样式**: 定制化的 CSS，模拟真实纸张/书籍的阅读体验（衬线字体、舒适的行高）。
*   **功能**: 支持 Markdown 语法高亮、快捷键操作、历史记录（撤销/重做）。

### 5.2 内容生成规范
*   **Prompt 优化**:
    *   角色设定：客观的历史记录者。
    *   风格要求：**白描**、去理论化、拒绝说教。
    *   结构要求：世界概览 -> 势力志 -> 编年史。

## 6. 故事引擎 (Story Engine)

### 6.1 生成控制台
*   **输入参数**:
    *   **当前时间/章节**: 定义生成的叙事节点。
    *   **正向提示词**: 指导 AI “必须做”的事情（如：引发一场暴乱）。
    *   **负面提示词**: 指导 AI “禁止做”的事情（如：不要写对话，不要死人）。
*   **状态反馈**: 实时显示当前系统各层级的实体数量，作为生成的上下文参考。

### 6.2 大纲生成
*   **Prompt 逻辑**:
    *   注入完整的世界模型（所有层级实体）。
    *   注入之前的故事情节（Context Window）。
    *   **输出要求**: 生成结构化的**故事大纲**（核心冲突、关键情节、系统影响分析），而非小说正文。
*   **展示**: 在右侧面板以时间线卡片的形式追加生成的大纲，支持 Markdown 渲染。

## 7. 任务管理系统 (Task Management System)

### 7.1 全局任务列表 (Global Task List)
*   **功能定位**: 统一管理所有后台异步操作，确保长时间运行的 AI 任务（如世界生成）不会阻塞 UI。
*   **UI 组件**: 悬浮或内嵌的任务面板，实时显示任务状态。
*   **任务类型**:
    *   **Running Characters**: 世界生成与实体补全任务。
    *   **Thinking**: AI 剧情分析与推演任务。
    *   **Writing**: 史书撰写任务。
*   **状态反馈**: 加载中 (Loading)、成功 (Success)、失败 (Error) 及错误信息展示。

### 7.2 世界生成队列
*   **机制**: 当用户触发“构建新世界”或“生成层级”时，创建异步任务。
*   **可视化**: 任务卡片显示当前生成的层级与实体数量进度，支持取消操作。

## 8. 系统配置 (System Configuration)

### 8.1 AI 参数设置 (AI Settings)
*   **模态框**: 提供专门的设置面板配置 LLM 连接参数。
*   **持久化**:
    *   **API Key**: 安全存储用户的 API 密钥。
    *   **Model Name**: 自定义模型名称 (如 `gemini-pro`, `gpt-4`)。
    *   **Base URL**: 支持自定义代理地址，解决网络访问问题。
*   **验证**: 提供“连通性测试”按钮，确保配置有效后再启用 AI 功能。

### 8.2 国际化 (Internationalization)
*   **架构**: 基于 `i18next` 的标准 i18n 实现。
*   **语言支持**:
    *   **中文 (zh)**: 默认语言，针对东亚文化背景优化 Prompt。
    *   **English (en)**: 国际通用版本。
*   **切换体验**: 设置中一键切换，应用即时刷新，无需重启。所有静态文案与动态生成的 Prompt 模板均适配当前语言。